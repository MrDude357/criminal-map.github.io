<script>
    // Конфигурация GitHub Gist
    const GIST_ID = 'cfeabd8cdf506711f2b7f55a0c0121ae'; // Замени на реальный ID gist
    const GITHUB_TOKEN = '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'; // Замени на твой GitHub token
    const GIST_FILENAME = 'gang_map_data.json';

    // Функции для работы с GitHub Gist
    async function saveToGist(territories) {
        try {
            const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    files: {
                        [GIST_FILENAME]: {
                            content: JSON.stringify({
                                territories: territories,
                                lastUpdate: new Date().toISOString()
                            }, null, 2)
                        }
                    }
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error('Ошибка сохранения в Gist:', error);
            // Если не получилось сохранить в облако, сохраняем локально
            localStorage.setItem('sfpd_gang_map_data', JSON.stringify({territories}));
            return null;
        }
    }

    async function loadFromGist() {
        try {
            const response = await fetch(`https://api.github.com/gists/${GIST_ID}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const gist = await response.json();
            const file = gist.files[GIST_FILENAME];
            
            if (file && file.content) {
                const data = JSON.parse(file.content);
                return data.territories || [];
            }
        } catch (error) {
            console.error('Ошибка загрузки из Gist:', error);
            // Если не получилось загрузить из облака, грузим локальные данные
            const localData = localStorage.getItem('sfpd_gang_map_data');
            return localData ? JSON.parse(localData).territories : [];
        }
        return [];
    }

    // Аудио элементы для звуков
    const typeSound = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==");
    const enterSound = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==");

    document.addEventListener('DOMContentLoaded', function() {
        const loadingScreen = document.getElementById('loading-screen');
        const mainInterface = document.getElementById('main-interface');
        const passwordDisplay = document.getElementById('password-display');
        const loadingDots = document.getElementById('loading-dots');
        const welcomeMessage = document.getElementById('welcome-message');
        const saveIndicator = document.getElementById('save-indicator');
        const exportDataBtn = document.getElementById('export-data');
        const importDataBtn = document.getElementById('import-data');
        const importFileInput = document.getElementById('import-file');
        
        // Функция для сохранения данных
        async function saveData() {
            await saveToGist(territories);
            
            // Показываем индикатор сохранения
            saveIndicator.style.display = 'block';
            setTimeout(() => {
                saveIndicator.style.display = 'none';
            }, 2000);
        }
        
        // Функция для загрузки данных
        async function loadData() {
            const loadedTerritories = await loadFromGist();
            if (loadedTerritories.length > 0) {
                territories = loadedTerritories;
                console.log('Данные загружены из облака:', territories.length, 'территорий');
                return true;
            }
            return false;
        }
        
        // Функция для экспорта данных в файл
        function exportData() {
            const dataToExport = {
                territories: territories,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `sfpd_gang_map_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('Данные успешно экспортированы!');
        }
        
        // Функция для импорта данных из файла
        function importData() {
            importFileInput.click();
        }
        
        // Обработчик выбора файла для импорта
        importFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    if (!importedData.territories || !Array.isArray(importedData.territories)) {
                        throw new Error('Неверный формат файла');
                    }
                    
                    if (confirm(`Импортировать ${importedData.territories.length} территорий? Существующие данные будут заменены.`)) {
                        territories = importedData.territories;
                        updateLegend();
                        drawMap();
                        saveData();
                        alert('Данные успешно импортированы!');
                    }
                } catch (error) {
                    console.error('Ошибка импорта:', error);
                    alert('Ошибка при импорте данных: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Сбрасываем input для возможности повторного выбора того же файла
            e.target.value = '';
        });
        
        // Функция для воспроизведения звука печата
        function playTypeSound() {
            typeSound.currentTime = 0;
            typeSound.play().catch(e => console.log('Audio play failed:', e));
        }
        
        // Функция для воспроизведения звука Enter
        function playEnterSound() {
            enterSound.currentTime = 0;
            enterSound.play().catch(e => console.log('Audio play failed:', e));
        }
        
        // Анимация авторизации
        async function startLoginAnimation() {
            // Ждём немного перед началом
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Печатаем пароль посимвольно
            const password = "••••••••••";
            let currentPassword = "";
            
            for (let i = 0; i < password.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 100 + Math.random() * 100));
                playTypeSound();
                currentPassword += password[i];
                passwordDisplay.innerHTML = currentPassword + '<span class="typing-cursor"></span>';
            }
            
            // Ждём немного и нажимаем Enter
            await new Promise(resolve => setTimeout(resolve, 800));
            playEnterSound();
            
            // Скрываем курсор и показываем точки загрузки
            passwordDisplay.innerHTML = password;
            loadingDots.style.display = 'block';
            
            // Загружаем сохраненные данные во время "загрузки"
            const dataLoaded = await loadData();
            if (dataLoaded) {
                console.log('Данные карты загружены');
            } else {
                console.log('Данные не загружены, используется локальное хранилище');
            }
            
            // Имитируем загрузку
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Показываем приветственное сообщение
            welcomeMessage.style.opacity = '1';
            welcomeMessage.style.transition = 'opacity 0.5s';
            
            // Ждём и скрываем экран загрузки
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Анимация исчезновения экрана загрузки
            loadingScreen.style.transition = 'transform 0.8s ease-in-out';
            loadingScreen.style.transform = 'translateY(-100%)';
            
            // Показываем основной интерфейс
            await new Promise(resolve => setTimeout(resolve, 500));
            mainInterface.style.opacity = '1';
            mainInterface.style.transform = 'translateY(0)';
            mainInterface.style.transition = 'opacity 0.5s, transform 0.5s';
            
            // Инициализируем карту после загрузки
            initMap();
        }
        
        // Запускаем анимацию при загрузке
        startLoginAnimation();

        // Остальной JavaScript код для карты
        const canvas = document.getElementById('map');
        const ctx = canvas.getContext('2d');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const resetViewBtn = document.getElementById('reset-view');
        const addTerritoryBtn = document.getElementById('add-territory');
        const cancelDrawingBtn = document.getElementById('cancel-drawing');
        const clearAllBtn = document.getElementById('clear-all');
        const infoModal = document.getElementById('info-modal');
        const saveInfoBtn = document.getElementById('save-info');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const deleteTerritoryBtn = document.getElementById('delete-territory');
        const legendContainer = document.getElementById('legend-container');
        const drawingStatus = document.getElementById('drawing-status');
        const modeNewBtn = document.getElementById('mode-new');
        const modeAddBtn = document.getElementById('mode-add');
        const modeDeleteBtn = document.getElementById('mode-delete');
        const modeTitle = document.getElementById('mode-title');
        const gangTooltip = document.getElementById('gang-tooltip');
        const tooltipEditBtn = document.getElementById('tooltip-edit');
        const tooltipCloseBtn = document.getElementById('tooltip-close');
        
        // Настройки карты
        let scale = 1;
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let lastX, lastY;
        let isDrawing = false;
        let startX, startY;
        let currentTerritory = null;
        let territories = []; // Теперь загружается из Gist
        let selectedTerritory = null;
        let selectedGang = null;
        let mode = 'new'; // 'new', 'add' или 'delete'
        
        // Загрузка изображения карты Сан Фиерро
        const mapImage = new Image();
        mapImage.crossOrigin = "anonymous";
        mapImage.src = 'https://i.imgur.com/VU8ljOJ.png';
        
        // Инициализация канваса
        function initMap() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            drawMap();
            
            // Обновляем легенду после загрузки данных
            updateLegend();
        }
        
        // Отрисовка карты и территорий
        function drawMap() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Сохраняем состояние контекста
            ctx.save();
            
            // Применяем трансформации (масштаб и смещение)
            ctx.translate(offsetX, offsetY);
            ctx.scale(scale, scale);
            
            // Рисуем карту
            ctx.drawImage(mapImage, 0, 0, 800, 600);
            
            // Рисуем все территории
            territories.forEach(territory => {
                ctx.fillStyle = territory.color;
                ctx.globalAlpha = 0.5;
                ctx.fillRect(territory.x, territory.y, territory.width, territory.height);
                ctx.globalAlpha = 1;
                ctx.strokeStyle = territory.color;
                ctx.lineWidth = 2;
                ctx.strokeRect(territory.x, territory.y, territory.width, territory.height);
                
                // Добавляем название банды
                ctx.fillStyle = '#fff';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(
                    territory.name, 
                    territory.x + territory.width / 2, 
                    territory.y + territory.height / 2
                );
            });
            
            // Рисуем текущую выделяемую территорию
            if (currentTerritory) {
                ctx.fillStyle = currentTerritory.color;
                ctx.globalAlpha = 0.3;
                ctx.fillRect(
                    currentTerritory.x, 
                    currentTerritory.y, 
                    currentTerritory.width, 
                    currentTerritory.height
                );
                ctx.globalAlpha = 1;
                ctx.strokeStyle = currentTerritory.color;
                ctx.lineWidth = 2;
                ctx.strokeRect(
                    currentTerritory.x, 
                    currentTerritory.y, 
                    currentTerritory.width, 
                    currentTerritory.height
                );
            }
            
            // Восстанавливаем состояние контекста
            ctx.restore();
        }
        
        // Обновление легенды
        function updateLegend() {
            if (territories.length === 0) {
                legendContainer.innerHTML = '<div class="legend-empty">Нет зарегистрированных группировок</div>';
                return;
            }
            
            // Удаляем дубликаты по названию банды
            const uniqueGangs = [];
            const gangNames = new Set();
            
            territories.forEach(territory => {
                if (!gangNames.has(territory.name)) {
                    gangNames.add(territory.name);
                    uniqueGangs.push(territory);
                }
            });
            
            legendContainer.innerHTML = '';
            
            uniqueGangs.forEach(gang => {
                const colorItem = document.createElement('div');
                colorItem.className = 'color-item';
                if (selectedGang && selectedGang.name === gang.name) {
                    colorItem.classList.add('selected');
                }
                colorItem.innerHTML = `
                    <div class="color-box" style="background-color: ${gang.color};"></div>
                    <span>${gang.name}</span>
                `;
                colorItem.addEventListener('click', () => selectGang(gang));
                legendContainer.appendChild(colorItem);
            });
        }
        
        // Выбор банды для добавления территории
        function selectGang(gang) {
            if (mode === 'delete') return;
            
            selectedGang = gang;
            updateLegend();
            
            if (mode === 'add') {
                document.getElementById('gang-name').value = gang.name;
                document.getElementById('gang-color').value = gang.color;
                document.getElementById('gang-name').disabled = true;
                document.getElementById('gang-color').disabled = true;
            }
        }
        
        // Смена режима
        function setMode(newMode) {
            mode = newMode;
            modeNewBtn.classList.toggle('active', mode === 'new');
            modeAddBtn.classList.toggle('active', mode === 'add');
            modeDeleteBtn.classList.toggle('active', mode === 'delete');
            
            // Убираем класс delete-mode с body
            document.body.classList.toggle('delete-mode', mode === 'delete');
            
            if (mode === 'new') {
                modeTitle.textContent = 'Добавить новую группировку';
                document.getElementById('gang-name').disabled = false;
                document.getElementById('gang-color').disabled = false;
                document.getElementById('gang-name').value = '';
                document.getElementById('gang-color').value = '#ff4444';
                selectedGang = null;
                updateLegend();
                canvas.style.cursor = 'crosshair';
            } else if (mode === 'add') {
                modeTitle.textContent = 'Добавить территорию к группировке';
                document.getElementById('gang-name').value = '';
                document.getElementById('gang-color').value = '#ff4444';
                document.getElementById('gang-name').disabled = true;
                document.getElementById('gang-color').disabled = true;
                canvas.style.cursor = 'crosshair';
            } else {
                modeTitle.textContent = 'Режим удаления территорий';
                document.getElementById('gang-name').disabled = true;
                document.getElementById('gang-color').disabled = true;
                canvas.style.cursor = 'not-allowed';
            }
            
            // Скрываем тултип при смене режима
            hideTooltip();
        }
        
        // Показать тултип с информацией
        function showTooltip(territory, x, y) {
            document.getElementById('tooltip-title').textContent = territory.name;
            document.getElementById('tooltip-leader-value').textContent = territory.leader || 'НЕ УСТАНОВЛЕН';
            document.getElementById('tooltip-members-value').textContent = territory.members || '0';
            document.getElementById('tooltip-description-value').textContent = territory.description || 'ИНФОРМАЦИЯ ОТСУТСТВУЕТ';
            
            // Позиционируем тултип рядом с курсором
            const tooltipWidth = gangTooltip.offsetWidth;
            const tooltipHeight = gangTooltip.offsetHeight;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            // Корректируем позицию, чтобы тултип не выходил за границы экрана
            let posX = x + 15;
            let posY = y - tooltipHeight / 2;
            
            if (posX + tooltipWidth > windowWidth) {
                posX = x - tooltipWidth - 15;
            }
            
            if (posY < 0) {
                posY = 10;
            } else if (posY + tooltipHeight > windowHeight) {
                posY = windowHeight - tooltipHeight - 10;
            }
            
            gangTooltip.style.left = posX + 'px';
            gangTooltip.style.top = posY + 'px';
            gangTooltip.style.display = 'block';
            
            selectedTerritory = territory;
        }
        
        // Скрыть тултип
        function hideTooltip() {
            gangTooltip.style.display = 'none';
            // НЕ сбрасываем selectedTerritory здесь, чтобы он сохранился для модального окна
        }
        
        // Удалить конкретную территорию
        function deleteTerritory(territory) {
            const index = territories.indexOf(territory);
            if (index > -1) {
                territories.splice(index, 1);
                updateLegend();
                drawMap();
                hideTooltip();
                selectedTerritory = null;
                saveData(); // Сохраняем изменения
            }
        }
        
        // Сохранить информацию о банде
        function saveGangInfo() {
            if (!selectedTerritory) {
                console.error('Нет выбранной территории для сохранения');
                alert('Ошибка: не выбрана территория для редактирования');
                return;
            }
            
            const newName = document.getElementById('modal-gang-name').value.trim();
            if (!newName) {
                alert('Пожалуйста, введите название банды');
                return;
            }
            
            const newLeader = document.getElementById('modal-gang-leader').value.trim();
            const newMembers = parseInt(document.getElementById('modal-gang-members').value) || 0;
            const newDescription = document.getElementById('modal-gang-description').value.trim();
            
            // Сохраняем старое название для поиска всех территорий этой банды
            const oldName = selectedTerritory.name;
            
            // Обновляем информацию во ВСЕХ территориях этой банды
            territories.forEach(territory => {
                if (territory.name === oldName) {
                    territory.name = newName;
                    territory.leader = newLeader;
                    territory.members = newMembers;
                    territory.description = newDescription;
                }
            });
            
            // Обновляем selectedGang если он был выбран
            if (selectedGang && selectedGang.name === oldName) {
                selectedGang.name = newName;
                selectedGang.leader = newLeader;
                selectedGang.members = newMembers;
                selectedGang.description = newDescription;
            }
            
            // Обновляем интерфейс
            updateLegend();
            drawMap();
            
            // Сохраняем изменения
            saveData();
            
            // Закрываем модальное окно
            infoModal.style.display = 'none';
            
            // Сбрасываем selectedTerritory только после сохранения
            selectedTerritory = null;
            
            alert('Информация о банде успешно сохранена!');
        }
        
        // Открыть модальное окно для редактирования
        function openEditModal(territory) {
            if (!territory) {
                console.error('Территория не определена');
                return;
            }
            
            // Заполняем поля формы
            document.getElementById('modal-gang-name').value = territory.name || '';
            document.getElementById('modal-gang-leader').value = territory.leader || '';
            document.getElementById('modal-gang-members').value = territory.members || '';
            document.getElementById('modal-gang-description').value = territory.description || '';
            
            // Сохраняем выбранную территорию
            selectedTerritory = territory;
            
            // Показываем модальное окно
            infoModal.style.display = 'flex';
            
            // Скрываем тултип, но НЕ сбрасываем selectedTerritory
            gangTooltip.style.display = 'none';
        }
        
        // Начало рисования территории
        function startDrawing(e) {
            if (!isDrawing || mode === 'delete') return;
            
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left - offsetX) / scale;
            const y = (e.clientY - rect.top - offsetY) / scale;
            
            let gangName, gangColor;
            
            if (mode === 'new') {
                gangName = document.getElementById('gang-name').value;
                gangColor = document.getElementById('gang-color').value;
            } else if (mode === 'add' && selectedGang) {
                gangName = selectedGang.name;
                gangColor = selectedGang.color;
            } else {
                alert('Выберите банду из списка для добавления территории');
                cancelDrawing();
                return;
            }
            
            if (!gangName) {
                alert('Пожалуйста, введите название банды');
                cancelDrawing();
                return;
            }
            
            // Для новой банды создаем базовую информацию
            let leader = '';
            let members = 0;
            let description = '';
            
            // Если добавляем к существующей банде, берем информацию из первой найденной территории
            if (mode === 'add' && selectedGang) {
                const existingTerritory = territories.find(t => t.name === gangName);
                if (existingTerritory) {
                    leader = existingTerritory.leader;
                    members = existingTerritory.members;
                    description = existingTerritory.description;
                }
            }
            
            currentTerritory = {
                x: x,
                y: y,
                width: 0,
                height: 0,
                color: gangColor,
                name: gangName,
                leader: leader,
                members: members,
                description: description
            };
            
            startX = x;
            startY = y;
        }
        
        // Обновление размера территории при движении мыши
        function updateDrawing(e) {
            if (!isDrawing || !currentTerritory) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left - offsetX) / scale;
            const y = (e.clientY - rect.top - offsetY) / scale;
            
            currentTerritory.width = x - startX;
            currentTerritory.height = y - startY;
            
            drawMap();
        }
        
        // Завершение рисования и сохранение территории
        function finishDrawing(e) {
            if (!isDrawing || !currentTerritory || mode === 'delete') return;
            
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left - offsetX) / scale;
            const y = (e.clientY - rect.top - offsetY) / scale;
            
            // Устанавливаем окончательные размеры
            currentTerritory.width = x - startX;
            currentTerritory.height = y - startY;
            
            // Проверяем, что территория имеет достаточный размер
            if (Math.abs(currentTerritory.width) > 5 && Math.abs(currentTerritory.height) > 5) {
                
                // Нормализуем координаты (ширина и высота могут быть отрицательными)
                if (currentTerritory.width < 0) {
                    currentTerritory.x = x;
                    currentTerritory.width = Math.abs(currentTerritory.width);
                }
                
                if (currentTerritory.height < 0) {
                    currentTerritory.y = y;
                    currentTerritory.height = Math.abs(currentTerritory.height);
                }
                
                // Сохраняем территорию
                territories.push({...currentTerritory});
                updateLegend();
                
                // Сохраняем данные
                saveData();
            }
            
            // Сбрасываем состояние рисования
            currentTerritory = null;
            isDrawing = false;
            canvas.style.cursor = mode === 'delete' ? 'not-allowed' : 'crosshair';
            drawingStatus.style.display = 'none';
            cancelDrawingBtn.style.display = 'none';
            addTerritoryBtn.disabled = false;
            
            drawMap();
        }
        
        // Отмена рисования
        function cancelDrawing() {
            isDrawing = false;
            currentTerritory = null;
            canvas.style.cursor = mode === 'delete' ? 'not-allowed' : 'crosshair';
            drawingStatus.style.display = 'none';
            cancelDrawingBtn.style.display = 'none';
            addTerritoryBtn.disabled = false;
            drawMap();
        }
        
        // Зум колесом мыши
        function handleWheel(e) {
            e.preventDefault();
            
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            // Преобразуем координаты мыши в координаты карты
            const worldX = (mouseX - offsetX) / scale;
            const worldY = (mouseY - offsetY) / scale;
            
            // Изменяем масштаб
            const zoomIntensity = 0.1;
            const wheel = e.deltaY < 0 ? 1 : -1;
            const newScale = scale * Math.exp(wheel * zoomIntensity);
            
            // Ограничиваем масштаб
            if (newScale < 0.1 || newScale > 5) return;
            
            // Корректируем смещение чтобы zoom был к курсору
            offsetX = mouseX - worldX * newScale;
            offsetY = mouseY - worldY * newScale;
            
            scale = newScale;
            drawMap();
        }
        
        // Обработчики событий для перемещения карты
        canvas.addEventListener('mousedown', function(e) {
            if (isDrawing && mode !== 'delete') {
                startDrawing(e);
                return;
            }
            
            isDragging = true;
            lastX = e.clientX;
            lastY = e.clientY;
            canvas.style.cursor = 'grabbing';
        });
        
        canvas.addEventListener('mousemove', function(e) {
            if (isDragging && !isDrawing) {
                const deltaX = e.clientX - lastX;
                const deltaY = e.clientY - lastY;
                offsetX += deltaX;
                offsetY += deltaY;
                lastX = e.clientX;
                lastY = e.clientY;
                drawMap();
            }
            
            if (isDrawing) {
                updateDrawing(e);
            }
        });
        
        canvas.addEventListener('mouseup', function(e) {
            if (isDragging) {
                isDragging = false;
                canvas.style.cursor = mode === 'delete' ? 'not-allowed' : 'crosshair';
            }
            
            if (isDrawing) {
                finishDrawing(e);
            }
        });
        
        // Обработчик клика по территории
        canvas.addEventListener('click', function(e) {
            if (isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left - offsetX) / scale;
            const y = (e.clientY - rect.top - offsetY) / scale;
            
            // Проверяем, попал ли клик в какую-либо территорию
            for (let i = territories.length - 1; i >= 0; i--) {
                const territory = territories[i];
                if (
                    x >= territory.x && 
                    x <= territory.x + territory.width && 
                    y >= territory.y && 
                    y <= territory.y + territory.height
                ) {
                    if (mode === 'delete') {
                        // Режим удаления - удаляем территорию
                        if (confirm(`Удалить эту территорию банды "${territory.name}"?`)) {
                            deleteTerritory(territory);
                        }
                    } else {
                        // Показываем информацию о территории
                        showTooltip(territory, e.clientX, e.clientY);
                    }
                    return;
                }
            }
            
            // Если клик не попал в территорию, скрываем тултип
            hideTooltip();
        });
        
        // Обработчики для кнопок
        addTerritoryBtn.addEventListener('click', function() {
            if (mode === 'add' && !selectedGang) {
                alert('Выберите банду из списка для добавления территории');
                return;
            }
            
            if (mode === 'new' && !document.getElementById('gang-name').value) {
                alert('Введите название новой банды');
                return;
            }
            
            isDrawing = true;
            canvas.style.cursor = 'crosshair';
            drawingStatus.style.display = 'block';
            cancelDrawingBtn.style.display = 'block';
            addTerritoryBtn.disabled = true;
        });
        
        cancelDrawingBtn.addEventListener('click', cancelDrawing);
        
        clearAllBtn.addEventListener('click', function() {
            if (confirm('ВНИМАНИЕ! Это действие удалит ВСЕ территории. Продолжить?')) {
                territories = [];
                updateLegend();
                drawMap();
                saveData(); // Сохраняем пустые данные
            }
        });
        
        // Кнопки зума
        zoomInBtn.addEventListener('click', function() {
            scale = Math.min(scale * 1.2, 5);
            drawMap();
        });
        
        zoomOutBtn.addEventListener('click', function() {
            scale = Math.max(scale / 1.2, 0.1);
            drawMap();
        });
        
        resetViewBtn.addEventListener('click', function() {
            scale = 1;
            offsetX = 0;
            offsetY = 0;
            drawMap();
        });
        
        // Кнопки режимов
        modeNewBtn.addEventListener('click', () => setMode('new'));
        modeAddBtn.addEventListener('click', () => setMode('add'));
        modeDeleteBtn.addEventListener('click', () => setMode('delete'));
        
        // Обработчики для тултипа
        tooltipEditBtn.addEventListener('click', function() {
            if (selectedTerritory) {
                openEditModal(selectedTerritory);
            }
        });
        
        tooltipCloseBtn.addEventListener('click', hideTooltip);
        
        // Обработчики для модального окна
        saveInfoBtn.addEventListener('click', saveGangInfo);
        
        cancelEditBtn.addEventListener('click', function() {
            infoModal.style.display = 'none';
            selectedTerritory = null;
        });
        
        deleteTerritoryBtn.addEventListener('click', function() {
            if (selectedTerritory && confirm(`УДАЛИТЬ ВСЕ ТЕРРИТОРИИ БАНДЫ "${selectedTerritory.name}"? Это действие нельзя отменить!`)) {
                // Удаляем ВСЕ территории этой банды
                const gangName = selectedTerritory.name;
                territories = territories.filter(t => t.name !== gangName);
                
                // Обновляем интерфейс
                updateLegend();
                drawMap();
                
                // Закрываем окна
                infoModal.style.display = 'none';
                hideTooltip();
                
                // Сбрасываем выбранную банду если она была удалена
                if (selectedGang && selectedGang.name === gangName) {
                    selectedGang = null;
                }
                
                // Сохраняем изменения
                saveData();
                
                alert(`Все территории банды "${gangName}" удалены!`);
            }
        });
        
        // Закрытие модального окна при клике вне его
        infoModal.addEventListener('click', function(e) {
            if (e.target === infoModal) {
                infoModal.style.display = 'none';
                selectedTerritory = null;
            }
        });
        
        // Обработчики для экспорта/импорта
        exportDataBtn.addEventListener('click', exportData);
        importDataBtn.addEventListener('click', importData);
        
        // Обработчик колеса мыши для зума
        canvas.addEventListener('wheel', handleWheel);
        
        // Обработчик изменения размера окна
        window.addEventListener('resize', initMap);
        
        // Инициализация интерфейса
        setMode('new');
    });
</script>